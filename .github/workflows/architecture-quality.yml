name: Architecture Quality Gate

on:
  push:
    branches: [ main, develop, development, enhanced-structure-preservation ]
  pull_request:
    branches: [ main, develop, development ]

jobs:
  architecture-compliance:
    runs-on: macos-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Make Scripts Executable
        run: |
          chmod +x Scripts/architecture-guard.sh
          chmod +x Scripts/pre-commit-enforcement.sh
          chmod +x Scripts/debt-trend-monitor.sh || true

      - name: Check if only workflow files changed
        id: workflow-only
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # Get list of changed files in the PR
            changed_files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD || echo "")
            # Check if only workflow files changed
            non_workflow_files=$(echo "$changed_files" | grep -v "^\.github/workflows/" | grep -v "^$" || true)
            if [ -z "$non_workflow_files" ]; then
              echo "only_workflow=true" >> $GITHUB_OUTPUT
              echo "âœ… Only workflow files changed - skipping strict architecture checks"
            else
              echo "only_workflow=false" >> $GITHUB_OUTPUT
              echo "ğŸ“ Non-workflow files changed - running full architecture checks"
            fi
          else
            echo "only_workflow=false" >> $GITHUB_OUTPUT
            echo "Push event - running full architecture checks"
          fi

      - name: Run Architecture Quality Check
        if: github.event_name != 'pull_request' || steps.workflow-only.outputs.only_workflow != 'true'
        run: |
          echo "ğŸ” Running PayslipMax Architecture Quality Gate..."
          ./Scripts/architecture-guard.sh --ci-mode

      - name: Generate Detailed Compliance Report
        if: github.event_name != 'pull_request' || steps.workflow-only.outputs.only_workflow != 'true'
        run: |
          echo "ğŸ“Š Generating Architecture Compliance Report..."
          ./Scripts/architecture-guard.sh --report > architecture-report.md || touch architecture-report.md

      - name: Check Violation Count
        id: violations
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ] && [ "${{ steps.workflow-only.outputs.only_workflow }}" == "true" ]; then
            echo "violations=0" >> $GITHUB_OUTPUT
            echo "Skipping violation check for workflow-only changes"
          else
            violations=$(./Scripts/architecture-guard.sh --count-violations || echo "0")
            echo "violations=$violations" >> $GITHUB_OUTPUT
            echo "Found $violations architectural violations"
          fi

      - name: Upload Architecture Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: architecture-report-${{ github.sha }}
          path: architecture-report.md
          retention-days: 30

      - name: Comment PR with Report (if PR)
        if: github.event_name == 'pull_request' && steps.violations.outputs.violations != '0'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const violations = '${{ steps.violations.outputs.violations }}';

            let comment = `## ğŸ—ï¸ Architecture Quality Report\n\n`;
            comment += `**Found ${violations} architectural violations**\n\n`;
            comment += `### ğŸ“‹ Quality Gate Status\n`;
            comment += violations === '0' ? 'âœ… All files comply with 300-line rule\n' : `âŒ ${violations} files exceed 300-line limit\n`;
            comment += `\n### ğŸ“Š Detailed Report\n`;
            comment += `See the uploaded artifact for detailed analysis.\n\n`;
            comment += `### ğŸ”§ Next Steps\n`;
            comment += `Run \`./Scripts/component-extraction-helper.sh <filename>\` to get refactoring suggestions.\n`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail Build on Violations (Strict Mode)
        if: |
          steps.violations.outputs.violations != '0' &&
          (github.event_name != 'pull_request' || steps.workflow-only.outputs.only_workflow != 'true')
        run: |
          violations="${{ steps.violations.outputs.violations }}"
          echo "âŒ Build failed: $violations architectural violations detected"
          echo "ğŸ”§ Fix violations before merging:"
          echo "   1. Run './Scripts/architecture-guard.sh --fix-suggestions' for specific guidance"
          echo "   2. Use component extraction patterns from the roadmap"
          echo "   3. Keep all files under 300 lines"
          exit 1

      - name: Success Notification
        if: steps.violations.outputs.violations == '0'
        run: |
          echo "âœ… Architecture Quality Gate Passed!"
          echo "ğŸ† All files comply with 300-line rule"
          echo "ğŸ“ˆ Quality score maintained at 94+/100"
