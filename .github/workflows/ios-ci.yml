name: iOS CI

on:
  push:
    branches: [ main, develop, development ]
  pull_request:
    branches: [ main, develop, development ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    name: Build & Test
    runs-on: macos-15
    timeout-minutes: 45

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.4'

      - name: Cache SPM Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Resolve Dependencies
        run: |
          xcodebuild -resolvePackageDependencies \
            -project PayslipMax.xcodeproj \
            -scheme PayslipMax

      - name: Build for Testing
        run: |
          set -o pipefail && xcodebuild build-for-testing \
            -project PayslipMax.xcodeproj \
            -scheme PayslipMax \
            -destination 'platform=iOS Simulator,name=iPhone 16 Pro,OS=18.4' \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            | xcpretty --color

      - name: Run Unit Tests
        run: |
          set -o pipefail && xcodebuild test-without-building \
            -project PayslipMax.xcodeproj \
            -scheme PayslipMax \
            -destination 'platform=iOS Simulator,name=iPhone 16 Pro,OS=18.4' \
            -resultBundlePath TestResults.xcresult \
            -enableCodeCoverage YES \
            | xcpretty --color --report junit --output test-results.xml
        continue-on-error: false

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ github.sha }}
          path: |
            TestResults.xcresult
            test-results.xml
          retention-days: 14

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        if: success()
        with:
          xcode: true
          xcode_archive_path: TestResults.xcresult
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  swiftlint:
    name: SwiftLint
    runs-on: macos-latest
    timeout-minutes: 10

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Run SwiftLint
        run: |
          swiftlint lint --reporter github-actions-logging --strict 2>&1 || true
          # Generate detailed report
          swiftlint lint --reporter json > swiftlint-report.json 2>&1 || true

      - name: Upload SwiftLint Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: swiftlint-report-${{ github.sha }}
          path: swiftlint-report.json
          retention-days: 14

      - name: Check for Errors
        run: |
          # Count errors (not warnings)
          error_count=$(swiftlint lint --reporter json 2>/dev/null | jq '[.[] | select(.severity == "Error")] | length' || echo "0")
          echo "SwiftLint errors: $error_count"
          if [ "$error_count" -gt 0 ]; then
            echo "âŒ SwiftLint found $error_count errors"
            swiftlint lint --reporter json 2>/dev/null | jq '[.[] | select(.severity == "Error")]' || true
            exit 1
          fi
          echo "âœ… SwiftLint passed (no errors)"

  architecture-quality:
    name: Architecture Quality
    runs-on: macos-latest
    timeout-minutes: 15

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Make Scripts Executable
        run: |
          chmod +x Scripts/architecture-guard.sh
          chmod +x Scripts/pre-commit-enforcement.sh
          chmod +x Scripts/debt-trend-monitor.sh || true

      - name: Check if only workflow files changed
        id: workflow-only
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            changed_files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD || echo "")
            non_workflow_files=$(echo "$changed_files" | grep -v "^\.github/workflows/" | grep -v "^$" || true)
            if [ -z "$non_workflow_files" ]; then
              echo "only_workflow=true" >> $GITHUB_OUTPUT
              echo "âœ… Only workflow files changed - skipping strict architecture checks"
            else
              echo "only_workflow=false" >> $GITHUB_OUTPUT
              echo "ğŸ“ Non-workflow files changed - running full architecture checks"
            fi
          else
            echo "only_workflow=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Architecture Quality Check
        if: steps.workflow-only.outputs.only_workflow != 'true'
        run: |
          echo "ğŸ” Running PayslipMax Architecture Quality Gate..."
          ./Scripts/architecture-guard.sh --ci-mode

      - name: Check Violation Count
        id: violations
        run: |
          if [ "${{ steps.workflow-only.outputs.only_workflow }}" == "true" ]; then
            echo "violations=0" >> $GITHUB_OUTPUT
          else
            violations=$(./Scripts/architecture-guard.sh --count-violations 2>&1 | grep -E '^[0-9]+$' | tail -1 || echo "0")
            echo "violations=$violations" >> $GITHUB_OUTPUT
            echo "Found $violations architectural violations"
          fi

      - name: Generate Health Report
        if: steps.workflow-only.outputs.only_workflow != 'true'
        run: |
          ./Scripts/architecture-guard.sh --report > architecture-report.md || touch architecture-report.md

      - name: Upload Architecture Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: architecture-report-${{ github.sha }}
          path: architecture-report.md
          retention-days: 30

      - name: Comment PR with Report
        if: github.event_name == 'pull_request' && steps.violations.outputs.violations != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const violations = '${{ steps.violations.outputs.violations }}';
            let comment = `## ğŸ—ï¸ Architecture Quality Report\n\n`;
            comment += `**Found ${violations} architectural violations**\n\n`;
            comment += `### ğŸ“‹ Quality Gate Status\n`;
            comment += violations === '0' ? 'âœ… All files comply with 300-line rule\n' : `âŒ ${violations} files exceed 300-line limit\n`;
            comment += `\n### ğŸ”§ Next Steps\n`;
            comment += `Run \`./Scripts/component-extraction-helper.sh <filename>\` to get refactoring suggestions.\n`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail on Violations
        if: steps.violations.outputs.violations != '0' && steps.workflow-only.outputs.only_workflow != 'true'
        run: |
          echo "âŒ Build failed: ${{ steps.violations.outputs.violations }} architectural violations detected"
          exit 1

  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check for Hardcoded Secrets
        run: |
          echo "ğŸ” Scanning for potential secrets..."
          
          # Check for common API key patterns
          if grep -rE "AIza[0-9A-Za-z_-]{35}" --include="*.swift" PayslipMax/ 2>/dev/null; then
            echo "âŒ Potential Google API key found in source code!"
            exit 1
          fi
          
          # Check for hardcoded credentials
          if grep -rEi "(password|secret|api_key|apikey)\s*=\s*[\"'][^\"']+[\"']" --include="*.swift" PayslipMax/ 2>/dev/null | grep -v "placeholder\|example\|YOUR_"; then
            echo "âŒ Potential hardcoded credentials found!"
            exit 1
          fi
          
          # Check for private keys
          if grep -r "BEGIN.*PRIVATE KEY" --include="*.swift" PayslipMax/ 2>/dev/null; then
            echo "âŒ Private key found in source code!"
            exit 1
          fi
          
          echo "âœ… No secrets detected in source code"

      - name: Verify GitIgnore Patterns
        run: |
          echo "ğŸ” Verifying .gitignore protections..."
          
          # Check that critical files are ignored
          patterns=("Config/APIKeys.swift" "GoogleService-Info.plist" "*.xcuserdata")
          
          for pattern in "${patterns[@]}"; do
            if ! grep -q "$pattern" .gitignore 2>/dev/null; then
              echo "âš ï¸  Warning: $pattern not found in .gitignore"
            fi
          done
          
          echo "âœ… GitIgnore verification complete"

  pr-validation:
    name: PR Validation
    if: github.event_name == 'pull_request'
    needs: [build-and-test, swiftlint, architecture-quality, security-check]
    runs-on: ubuntu-latest

    steps:
      - name: All Checks Passed
        run: |
          echo "âœ… All CI checks passed!"
          echo "ğŸ“‹ Summary:"
          echo "  - Build & Test: âœ…"
          echo "  - SwiftLint: âœ…"
          echo "  - Architecture Quality: âœ…"
          echo "  - Security Check: âœ…"
          echo ""
          echo "ğŸ‰ Ready for code review and merge!"

